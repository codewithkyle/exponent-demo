let resourcesCacheId="resouces-initial",contentCacheId="content-initial";function clearContentCache(){caches.keys().then(e=>Promise.all(e.map(e=>{if(e.match("content"))return caches.delete(e)})))}async function cachebust(e,t){const c=await fetch("/pwa/cachebust",{cache:"no-cache",credentials:"include",headers:new Headers({Accept:"application/json"})});if(c.ok){const t=await c.json();if(t.success){resourcesCacheId=`resources-${t.resourcesCache}`,contentCacheId=`content-${t.contentCache}`,caches.keys().then(e=>Promise.all(e.map(e=>{if(e!==resourcesCacheId&&e!==contentCacheId)return caches.delete(e)}))),(await self.clients.matchAll()).map(c=>{"visible"===c.visibilityState&&c.url===e&&c.postMessage({type:"cachebust",max:parseInt(t.maximumContentPrompts),contentCacheExpires:parseInt(t.contentCacheDuration)})})}else console.error(t.error)}}async function updatePageCache(e,t){try{const c=new Request(e);await new Promise(e=>{caches.open(contentCacheId).then(t=>{t.delete(c).then(()=>{e()})})}),"4g"===t&&await new Promise(t=>{fetch(e,{credentials:"include"}).then(e=>{e&&200===e.status&&"basic"===e.type||t(),caches.open(contentCacheId).then(a=>{a.put(c,e),t()})})}),(await self.clients.matchAll()).map(t=>{"visible"===t.visibilityState&&t.url===e&&t.postMessage({type:"page-refresh"})})}catch(e){console.error(e)}}self.addEventListener("fetch",e=>{if(e.request.url.match(/(\/webmaster\/)|(\/cpresources\/)|(index\.php)|(cachebust)|(\/pwa\/)|(\.json)$/gi)||"GET"!==e.request.method)e.respondWith(fetch(e.request).then(e=>e));else{const t=e.request.url.match(/(\.js)$|(\.css)$/gi)?resourcesCacheId:contentCacheId;e.respondWith(caches.match(e.request).then(c=>c||fetch(e.request).then(c=>{if(!c||200!==c.status||"basic"!==c.type||"no-cache"===c.headers.get("PWA-Cache"))return c;var a=c.clone();return caches.open(t).then(t=>{t.put(e.request,a)}),c})))}}),self.addEventListener("message",e=>{const{type:t}=e.data;switch(t){case"cachebust":cachebust(e.data.url,e.data.contentCache);break;case"page-refresh":updatePageCache(e.data.url,e.data.network);break;case"clear-content-cache":clearContentCache();break;default:console.error(`Unknown Service Worker message type: ${t}`)}});